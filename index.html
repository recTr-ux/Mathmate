<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MathMate - Ton Tuteur IA Personnel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.338/pdf.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ‚ö†Ô∏è IMPORTANT: Change cette URL par ton URL Vercel
        const API_URL = '/api/chat';
        // Pour le d√©veloppement local: 'http://localhost:3000/api/chat'

        function MathMate() {
            const [currentView, setCurrentView] = useState('welcome');
            const [profile, setProfile] = useState(null);
            const [conversations, setConversations] = useState([]);
            const [currentConversation, setCurrentConversation] = useState([]);
            const [input, setInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [attachedFiles, setAttachedFiles] = useState([]);
            const chatEndRef = useRef(null);
            const fileInputRef = useRef(null);

            useEffect(() => {
                const saved = localStorage.getItem('mathmate-profile');
                if (saved) {
                    setProfile(JSON.parse(saved));
                    const savedConvos = localStorage.getItem('mathmate-conversations');
                    if (savedConvos) setConversations(JSON.parse(savedConvos));
                }
            }, []);

            useEffect(() => {
                chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [currentConversation]);

            const topics = [
                'Fonctions (limites, continuit√©)',
                'D√©rivation',
                'Suites num√©riques',
                'Trigonom√©trie',
                'Probabilit√©s',
                'G√©om√©trie analytique',
                'Exponentielles et logarithmes',
                'Int√©gration',
                'Nombres complexes'
            ];

            const handleCreateProfile = (formData) => {
                const newProfile = {
                    name: formData.name,
                    grade: formData.grade,
                    difficulties: formData.difficulties,
                    createdAt: new Date().toISOString()
                };
                setProfile(newProfile);
                localStorage.setItem('mathmate-profile', JSON.stringify(newProfile));
                setCurrentView('home');
            };

            const handleFileSelect = async (e) => {
                const files = Array.from(e.target.files);
                const newFiles = [];

                for (const file of files) {
                    if (file.type.startsWith('image/')) {
                        const base64 = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = () => resolve(reader.result.split(',')[1]);
                            reader.onerror = reject;
                            reader.readAsDataURL(file);
                        });
                        newFiles.push({
                            name: file.name,
                            type: 'image',
                            media_type: file.type,
                            base64: base64
                        });
                    } else if (file.type === 'application/pdf') {
                        const arrayBuffer = await file.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                        let extractedText = '';
                        const maxPages = Math.min(pdf.numPages, 5);
                        for (let i = 1; i <= maxPages; i++) {
                            const page = await pdf.getPage(i);
                            const content = await page.getTextContent();
                            extractedText += content.items.map(item => item.str).join(' ') + '\n\n';
                        }
                        newFiles.push({
                            name: file.name,
                            type: 'text',
                            content: extractedText
                        });
                    }
                }

                setAttachedFiles([...attachedFiles, ...newFiles]);
            };

            const removeFile = (index) => {
                setAttachedFiles(attachedFiles.filter((_, i) => i !== index));
            };

            const handleSendMessage = async () => {
                if ((!input.trim() && attachedFiles.length === 0) || isLoading) return;

                const userMessage = {
                    role: 'user',
                    content: input,
                    files: attachedFiles.length > 0 ? [...attachedFiles] : null
                };

                const updatedConvo = [...currentConversation, userMessage];
                setCurrentConversation(updatedConvo);
                setInput('');
                const filesToProcess = [...attachedFiles];
                setAttachedFiles([]);
                setIsLoading(true);

                try {
                    const systemPrompt = `Tu es MathMate, un tuteur de math√©matiques pour lyc√©ens fran√ßais. Ton r√¥le est d'aider l'√©l√®ve √† COMPRENDRE, pas de donner directement les r√©ponses.

PROFIL DE L'√âL√àVE:
- Classe: ${profile.grade}
- Difficult√©s principales: ${profile.difficulties.join(', ')}

M√âTHODE SOCRATIQUE - R√àGLES STRICTES:
1. Ne donne JAMAIS la r√©ponse finale directement
2. Pose des questions qui guident l'√©l√®ve vers la solution
3. D√©compose les probl√®mes en √©tapes simples
4. Encourage et f√©licite les efforts
5. Si l'√©l√®ve est bloqu√©, donne un petit indice, puis une autre question

STYLE:
- Tutoie l'√©l√®ve
- Sois encourageant et patient
- Utilise des √©mojis occasionnellement
- Reste concis (2-4 phrases max par r√©ponse)`;

                    const messageContent = [];
                    
                    if (filesToProcess.length > 0) {
                        for (const file of filesToProcess) {
                            if (file.type === 'image') {
                                messageContent.push({
                                    type: "image",
                                    source: {
                                        type: "base64",
                                        media_type: file.media_type,
                                        data: file.base64
                                    }
                                });
                            } else if (file.type === 'text') {
                                messageContent.push({
                                    type: "text",
                                    text: `Contenu extrait du PDF ${file.name}: ${file.content}`
                                });
                            }
                        }
                    }

                    const textContent = input.trim() || "Peux-tu m'aider avec ce document ?";
                    messageContent.push({
                        type: "text",
                        text: textContent
                    });

                    const messages = [
                        ...updatedConvo.slice(0, -1).map(msg => ({
                            role: msg.role,
                            content: msg.content
                        })),
                        {
                            role: 'user',
                            content: messageContent
                        }
                    ];

                    // Appel au backend s√©curis√©
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            messages: messages,
                            systemPrompt: systemPrompt
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `Erreur ${response.status}`);
                    }

                    const data = await response.json();
                    const assistantMessage = {
                        role: 'assistant',
                        content: data.content[0].text
                    };

                    const finalConvo = [...updatedConvo, assistantMessage];
                    setCurrentConversation(finalConvo);

                    const newConversations = [...conversations];
                    const existingIndex = newConversations.findIndex(c => c.id === 'current');
                    if (existingIndex >= 0) {
                        newConversations[existingIndex] = {
                            id: 'current',
                            messages: finalConvo,
                            timestamp: new Date().toISOString()
                        };
                    } else {
                        newConversations.push({
                            id: 'current',
                            messages: finalConvo,
                            timestamp: new Date().toISOString()
                        });
                    }
                    setConversations(newConversations);
                    localStorage.setItem('mathmate-conversations', JSON.stringify(newConversations));

                } catch (error) {
                    console.error('Erreur:', error);
                    setCurrentConversation([...updatedConvo, {
                        role: 'assistant',
                        content: 'üòï D√©sol√©, une erreur est survenue. V√©rifie que le backend est bien configur√© et r√©essaie !'
                    }]);
                }

                setIsLoading(false);
            };

            if (!profile) {
                return <WelcomeScreen onComplete={handleCreateProfile} topics={topics} />;
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-50 via-white to-purple-50">
                    <nav className="bg-white border-b border-gray-200 px-6 py-4">
                        <div className="max-w-7xl mx-auto flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-xl flex items-center justify-center">
                                    <span className="text-white font-bold text-xl">M</span>
                                </div>
                                <div>
                                    <h1 className="text-xl font-bold text-gray-900">MathMate</h1>
                                    <p className="text-xs text-gray-500">Ton tuteur perso</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-2">
                                <button onClick={() => setCurrentView('home')} className={`p-2 rounded-lg ${currentView === 'home' ? 'bg-indigo-100 text-indigo-600' : 'text-gray-600 hover:bg-gray-100'}`}>
                                    üè†
                                </button>
                                <button onClick={() => setCurrentView('chat')} className={`p-2 rounded-lg ${currentView === 'chat' ? 'bg-indigo-100 text-indigo-600' : 'text-gray-600 hover:bg-gray-100'}`}>
                                    üí¨
                                </button>
                                <button onClick={() => setCurrentView('progress')} className={`p-2 rounded-lg ${currentView === 'progress' ? 'bg-indigo-100 text-indigo-600' : 'text-gray-600 hover:bg-gray-100'}`}>
                                    üìä
                                </button>
                            </div>
                        </div>
                    </nav>

                    <div className="max-w-7xl mx-auto p-6">
                        {currentView === 'home' && <HomeView profile={profile} onStartChat={() => setCurrentView('chat')} />}
                        {currentView === 'chat' && (
                            <ChatView
                                conversation={currentConversation}
                                input={input}
                                setInput={setInput}
                                onSend={handleSendMessage}
                                isLoading={isLoading}
                                chatEndRef={chatEndRef}
                                attachedFiles={attachedFiles}
                                onFileSelect={handleFileSelect}
                                onRemoveFile={removeFile}
                                fileInputRef={fileInputRef}
                            />
                        )}
                        {currentView === 'progress' && <ProgressView profile={profile} conversations={conversations} />}
                    </div>
                </div>
            );
        }

        function WelcomeScreen({ onComplete, topics }) {
            const [step, setStep] = useState(1);
            const [formData, setFormData] = useState({
                name: '',
                grade: 'Seconde',
                difficulties: []
            });

            const handleSubmit = () => {
                if (formData.name && formData.difficulties.length > 0) {
                    onComplete(formData);
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500 flex items-center justify-center p-6">
                    <div className="bg-white rounded-3xl shadow-2xl max-w-2xl w-full p-8">
                        {step === 1 && (
                            <div className="text-center space-y-6">
                                <div className="w-20 h-20 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-2xl mx-auto flex items-center justify-center text-5xl">
                                    üìö
                                </div>
                                <div>
                                    <h1 className="text-4xl font-bold text-gray-900 mb-2">Bienvenue sur MathMate</h1>
                                    <p className="text-gray-600 text-lg">Ton tuteur IA personnel qui t'aide √† vraiment comprendre les maths</p>
                                </div>
                                <div className="bg-indigo-50 rounded-xl p-6 text-left space-y-3">
                                    <h3 className="font-semibold text-indigo-900 mb-3">Ce que je fais pour toi :</h3>
                                    <div className="flex items-start gap-3">
                                        <div className="w-6 h-6 bg-indigo-500 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                            <span className="text-white text-sm">‚úì</span>
                                        </div>
                                        <p className="text-gray-700">Je ne donne pas les r√©ponses, je te guide pour que TU comprennes</p>
                                    </div>
                                    <div className="flex items-start gap-3">
                                        <div className="w-6 h-6 bg-indigo-500 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                            <span className="text-white text-sm">‚úì</span>
                                        </div>
                                        <p className="text-gray-700">Je m'adapte √† ton niveau et tes difficult√©s</p>
                                    </div>
                                    <div className="flex items-start gap-3">
                                        <div className="w-6 h-6 bg-indigo-500 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                            <span className="text-white text-sm">‚úì</span>
                                        </div>
                                        <p className="text-gray-700">Tu peux m'envoyer des photos d'exercices ou des PDFs</p>
                                    </div>
                                </div>
                                <button onClick={() => setStep(2)} className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-xl font-semibold hover:shadow-lg transition-all">
                                    Commencer
                                </button>
                            </div>
                        )}

                        {step === 2 && (
                            <div className="space-y-6">
                                <h2 className="text-2xl font-bold text-gray-900">Cr√©ons ton profil</h2>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Ton pr√©nom</label>
                                        <input type="text" value={formData.name} onChange={(e) => setFormData({...formData, name: e.target.value})} className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Ex: Marie" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Ta classe</label>
                                        <select value={formData.grade} onChange={(e) => setFormData({...formData, grade: e.target.value})} className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                            <option>Seconde</option>
                                            <option>Premi√®re</option>
                                            <option>Terminale</option>
                                        </select>
                                    </div>
                                </div>
                                <button onClick={() => setStep(3)} disabled={!formData.name} className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-xl font-semibold hover:shadow-lg transition-all disabled:opacity-50">
                                    Suivant
                                </button>
                            </div>
                        )}

                        {step === 3 && (
                            <div className="space-y-6">
                                <div>
                                    <h2 className="text-2xl font-bold text-gray-900 mb-2">Tes difficult√©s</h2>
                                    <p className="text-gray-600">S√©lectionne les chapitres o√π tu gal√®res (minimum 1)</p>
                                </div>
                                <div className="grid grid-cols-1 gap-3">
                                    {topics.map((topic) => (
                                        <button key={topic} onClick={() => {
                                            const current = formData.difficulties;
                                            if (current.includes(topic)) {
                                                setFormData({...formData, difficulties: current.filter(t => t !== topic)});
                                            } else {
                                                setFormData({...formData, difficulties: [...current, topic]});
                                            }
                                        }} className={`p-4 rounded-xl border-2 text-left transition-all ${formData.difficulties.includes(topic) ? 'border-indigo-500 bg-indigo-50' : 'border-gray-200 hover:border-gray-300'}`}>
                                            <span className={`font-medium ${formData.difficulties.includes(topic) ? 'text-indigo-900' : 'text-gray-700'}`}>
                                                {topic}
                                            </span>
                                        </button>
                                    ))}
                                </div>
                                <button onClick={handleSubmit} disabled={formData.difficulties.length === 0} className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-xl font-semibold hover:shadow-lg transition-all disabled:opacity-50">
                                    Terminer
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function HomeView({ profile, onStartChat }) {
            return (
                <div className="space-y-6">
                    <div className="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl p-8 text-white">
                        <h2 className="text-3xl font-bold mb-2">Salut {profile.name} ! üëã</h2>
                        <p className="text-indigo-100 text-lg">Pr√™t √† progresser en maths aujourd'hui ?</p>
                    </div>
                    <div className="grid md:grid-cols-2 gap-6">
                        <button onClick={onStartChat} className="bg-white rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all border-2 border-transparent hover:border-indigo-500 text-left group">
                            <div className="w-12 h-12 bg-indigo-100 rounded-xl flex items-center justify-center mb-4 group-hover:bg-indigo-500 transition-colors text-3xl">
                                üí¨
                            </div>
                            <h3 className="text-xl font-bold text-gray-900 mb-2">Poser une question</h3>
                            <p className="text-gray-600">Commence une nouvelle session</p>
                        </button>
                        <div className="bg-white rounded-2xl p-6 shadow-lg border border-gray-200">
                            <div className="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center mb-4 text-3xl">
                                üìé
                            </div>
                            <h3 className="text-xl font-bold text-gray-900 mb-2">Envoie tes documents</h3>
                            <p className="text-gray-600">Photos, PDFs... tout est analysable !</p>
                        </div>
                    </div>
                </div>
            );
        }

        function ChatView({ conversation, input, setInput, onSend, isLoading, chatEndRef, attachedFiles, onFileSelect, onRemoveFile, fileInputRef }) {
            return (
                <div className="bg-white rounded-2xl shadow-lg border border-gray-200 h-[calc(100vh-180px)] flex flex-col">
                    <div className="p-6 border-b border-gray-200">
                        <h2 className="text-xl font-bold text-gray-900">Session de travail</h2>
                        <p className="text-sm text-gray-600">Pose-moi ta question ou envoie un document</p>
                    </div>
                    <div className="flex-1 overflow-y-auto p-6 space-y-4">
                        {conversation.length === 0 && (
                            <div className="text-center py-12">
                                <div className="text-6xl mb-4">üí¨</div>
                                <h3 className="text-lg font-semibold text-gray-900 mb-2">Commence ta session</h3>
                                <p className="text-gray-600 mb-4">Pose-moi une question ou envoie une photo/PDF</p>
                            </div>
                        )}
                        {conversation.map((msg, i) => (
                            <div key={i} className={`flex gap-3 ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                {msg.role === 'assistant' && (
                                    <div className="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-lg flex items-center justify-center flex-shrink-0">
                                        <span className="text-white font-bold text-sm">M</span>
                                    </div>
                                )}
                                <div className={`max-w-[80%] rounded-2xl px-4 py-3 ${msg.role === 'user' ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-900'}`}>
                                    {msg.files && msg.files.length > 0 && (
                                        <div className="mb-2 space-y-2">
                                            {msg.files.map((file, idx) => (
                                                <div key={idx} className="flex items-center gap-2 p-2 bg-white bg-opacity-20 rounded-lg">
                                                    <span className="text-sm truncate">{file.name}</span>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                    <p className="whitespace-pre-wrap">{msg.content}</p>
                                </div>
                            </div>
                        ))}
                        {isLoading && (
                            <div className="flex gap-3">
                                <div className="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-lg flex items-center justify-center">
                                    <span className="text-white font-bold text-sm">M</span>
                                </div>
                                <div className="bg-gray-100 rounded-2xl px-4 py-3">
                                    <div className="flex gap-1">
                                        <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                                        <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{animationDelay: '0.1s'}}></div>
                                        <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></div>
                                    </div>
                                </div>
                            </div>
                        )}
                        <div ref={chatEndRef} />
                    </div>
                    <div className="p-6 border-t border-gray-200">
                        {attachedFiles.length > 0 && (
                            <div className="mb-3 flex flex-wrap gap-2">
                                {attachedFiles.map((file, idx) => (
                                    <div key={idx} className="flex items-center gap-2 bg-indigo-50 text-indigo-700 px-3 py-2 rounded-lg">
                                        <span className="text-sm truncate max-w-[150px]">{file.name}</span>
                                        <button onClick={() => onRemoveFile(idx)} className="hover:text-indigo-900">‚úï</button>
                                    </div>
                                ))}
                            </div>
                        )}
                        <div className="flex gap-3">
                            <input ref={fileInputRef} type="file" accept="image/*,.pdf" multiple onChange={onFileSelect} className="hidden" />
                            <button onClick={() => fileInputRef.current?.click()} className="p-3 border-2 border-gray-300 rounded-xl hover:border-indigo-500 hover:bg-indigo-50 transition-all" disabled={isLoading}>
                                üìé
                            </button>
                            <input type="text" value={input} onChange={(e) => setInput(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && onSend()} placeholder="√âcris ta question ici..." className="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent" disabled={isLoading} />
                            <button onClick={onSend} disabled={(!input.trim() && attachedFiles.length === 0) || isLoading} className="px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl font-semibold hover:shadow-lg transition-all disabled:opacity-50">
                                ‚û§
                            </button>
                        </div>
                        <p className="text-xs text-gray-500 mt-2">üì∏ Accepte : Images et PDFs</p>
                    </div>
                </div>
            );
        }

        function ProgressView({ profile, conversations }) {
            const totalMessages = conversations.reduce((sum, c) => sum + c.messages.length, 0);
            const sessionsCount = conversations.length;

            return (
                <div className="space-y-6">
                    <div className="bg-white rounded-2xl p-6 shadow-lg border border-gray-200">
                        <h2 className="text-2xl font-bold text-gray-900 mb-6">Ta progression</h2>
                        <div className="grid md:grid-cols-3 gap-6">
                            <div className="bg-gradient-to-br from-indigo-50 to-indigo-100 rounded-xl p-6">
                                <div className="text-4xl mb-2">üìà</div>
                                <div className="text-3xl font-bold text-indigo-900 mb-1">{sessionsCount}</div>
                                <div className="text-sm text-indigo-700">Sessions</div>
                            </div>
                            <div className="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-6">
                                <div className="text-4xl mb-2">üí¨</div>
                                <div className="text-3xl font-bold text-purple-900 mb-1">{totalMessages}</div>
                                <div className="text-sm text-purple-700">Messages</div>
                            </div>
                            <div className="bg-gradient-to-br from-pink-50 to-pink-100 rounded-xl p-6">
                                <div className="text-4xl mb-2">üéØ</div>
                                <div className="text-3xl font-bold text-pink-900 mb-1">{profile.difficulties.length}</div>
                                <div className="text-sm text-pink-700">Chapitres</div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<MathMate />, document.getElementById('root'));
    </script>
</body>
</html>
